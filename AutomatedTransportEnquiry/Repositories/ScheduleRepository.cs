using AutomatedTransportEnquiry.Data;
using AutomatedTransportEnquiry.DTOs;
using AutomatedTransportEnquiry.Models;
using Dapper;

namespace AutomatedTransportEnquiry.Repositories
{
    public class ScheduleRepository :IScheduleRepository
    {
        private readonly DapperContext _context;
        public ScheduleRepository(DapperContext context)
        {
            _context = context;

        }
        public async Task<IEnumerable<ScheduleDto>> GetAllAsync(string from,string to)
        {
           
            var query = @"SELECT s.ScheduleId,v.VehicleType,CONCAT(r.Source, ' - ' ,r.Destination) AS RouteName,
                           s.DepartureTime,
                           s.ArrivalTime,
                           s.Price,
                           s.TravelDate
                          FROM Schedules s
                          JOIN Vehicles v ON v.VehicleId = s.VehicleId
                          JOIN Routes r ON r.RouteId = s.RouteId WHERE r.Source = @From AND r.Destination = @To";
            using var connection = _context.CreateConnection();
            
            return await connection.QueryAsync<ScheduleDto>(query, new { from, to});
        }
        public async Task<int> CreateAsync(Schedule schedule)
        {
          var query = @"
          INSERT INTO Schedules
          (VehicleId, RouteId, DepartureTime, ArrivalTime, Price,TravelDate)
          VALUES
          (@VehicleId, @RouteId, @DepartureTime, @ArrivalTime, @Price,@TravelDate);

          SELECT CAST(SCOPE_IDENTITY() AS INT);  ";
            using var connection = _context.CreateConnection();
            return await connection.ExecuteScalarAsync<int>(query,schedule);
        }


    }
}
